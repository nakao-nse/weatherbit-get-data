# Weatherbit実績データ取得Lambda関数 仕様書

## 1. 概要

Weatherbit APIからHourly Historical Weatherデータを取得し、S3にCSV形式で保存するAWS Lambda関数。

## 2. 機能要件

### 2.1 主要機能
- EventBridgeから1日1回実行される
- 前日の24時間分の気象データを取得
- 取得したJSONデータをCSV形式に変換
- S3バケットに保存（年フォルダ配下、月単位のファイル）

### 2.2 実行環境
- ローカル実行とAWS上での実行を環境変数で切り替え可能

## 3. 技術要件

### 3.1 使用技術
- Python 3.x
- AWS Lambda
- AWS S3
- AWS EventBridge
- Weatherbit API (Hourly Historical Weather)

### 3.2 API仕様
- エンドポイント: `https://api.weatherbit.io/v2.0/history/hourly`
- 認証: API Key（環境変数から取得）
- リクエストパラメータ:
  - `lat`: 緯度
  - `lon`: 経度
  - `start_date`: 開始日（YYYY-MM-DD）
  - `end_date`: 終了日（YYYY-MM-DD）
  - `key`: API Key

### 3.3 データ形式

#### 3.3.1 イベント入力形式
単一地点・複数地点ともに`locations`配列形式で統一します。

単一地点の場合:
```json
{
  "locations": [
    {
      "lat": 36.1833,
      "lon": 139.7167,
      "point": "Koga"
    }
  ],
  "date": "2026-01-09"  // 前日の日付（YYYY-MM-DD形式、JST基準）
}
```

複数地点の場合:
```json
{
  "locations": [
    {
      "lat": 36.1833,
      "lon": 139.7167,
      "point": "Koga"
    },
    {
      "lat": 35.6762,
      "lon": 139.6503,
      "point": "Tokyo"
    }
  ],
  "date": "2026-01-09"  // 前日の日付（YYYY-MM-DD形式、JST基準）
}
```

#### 3.3.2 APIレスポンス形式（JSON）
```json
{
  "city_name": "Koga",
  "country_code": "JP",
  "data": [
    {
      "datetime": "2026-01-09:02",
      "timestamp_utc": "2026-01-09T02:00:00",
      "timestamp_local": "2026-01-09T11:00:00",
      "ts": 1767924000,
      "temp": 6.7,
      "app_temp": 4.8,
      "rh": 52,
      "dewpt": -2.5,
      "pres": 1022,
      "slp": 1024,
      "clouds": 0,
      "vis": 24,
      "wind_spd": 2.65,
      "wind_dir": 158,
      "wind_cdir": "SSE",
      "wind_cdir_full": "south-southeast",
      "wind_gust_spd": 5.9,
      "precip": 0,
      "snow": 0,
      "snow_depth": 0,
      "uv": 3,
      "ozone": 309,
      "solar_rad": 506.85,
      "ghi": 507,
      "dni": 814,
      "dhi": 98,
      "pop": 0,
      "weather": {
        "code": 800,
        "description": "Clear Sky",
        "icon": "c01d"
      }
    }
  ]
}
```

#### 3.3.3 CSV出力形式
- エンコーディング: Shift-JIS
- ヘッダー行: 各フィールド名
- データ行: 各時間のデータ
- ネストされたオブジェクト（weather等）は展開して保存
  - `weather.code` → `weather_code`
  - `weather.description` → `weather_description`
  - `weather.icon` → `weather_icon`
- 日付時刻フォーマット: ISO形式（JST）

### 3.4 S3保存形式
- パス: `{S3_BUCKET}/{S3_PREFIX}/{point}/{YYYY}/wb_{YYYY}_{MM}.csv`
- 例: `my-bucket/weather-data/Koga/2026/wb_2026_01.csv`
- 地点名（point）ごとにフォルダを分けて保存

## 4. 環境変数

| 変数名 | 説明 | 必須 | デフォルト値 |
|--------|------|------|--------------|
| `WEATHERBIT_API_KEY` | Weatherbit API Key | 必須 | - |
| `S3_BUCKET` | S3バケット名 | 必須 | - |
| `S3_PREFIX` | S3プレフィックス | 必須 | - |
| `EXECUTION_MODE` | 実行モード（`local` または `aws`） | 必須 | `aws` |
| `LOCAL_OUTPUT_DIR` | ローカル実行時の出力ディレクトリ（EXECUTION_MODE=local時のみ） | 条件付き | `./output` |

## 5. 処理フロー

1. **イベント受信**
   - EventBridgeからイベントを受信
   - 位置情報（lat, lon）と日付を取得

2. **日付計算**
   - イベントの日付から前日の日付を計算（JST基準）
   - 開始日と終了日を設定（前日の00:00:00～23:59:59 JST）

3. **API呼び出し**
   - Weatherbit APIにリクエスト送信
   - エラーハンドリング（リトライ、ログ出力）

4. **データ変換**
   - JSONレスポンスをパース
   - CSV形式に変換（ネストされたオブジェクトを展開）

5. **ファイル保存**
   - 実行モードに応じて保存先を決定
     - `aws`: S3に保存
     - `local`: ローカルディレクトリに保存
   - 既存ファイルがある場合は追記（月単位でまとめる）
   - 重複データのチェックを実施（timestamp_utcとlat, lonの組み合わせで判定）

6. **ログ出力**
   - 処理開始/終了ログ
   - エラーログ
   - 取得データ件数

## 6. エラーハンドリング

### 6.1 API呼び出しエラー
- HTTPエラー: ステータスコードとエラーメッセージをログ出力
- タイムアウト: リトライ（最大3回、指数バックオフ）
- API制限エラー: 適切なエラーメッセージを返す

### 6.2 S3保存エラー
- バケット不存在: エラーログ出力
- 権限エラー: エラーログ出力
- ネットワークエラー: リトライ

### 6.3 データ変換エラー
- JSONパースエラー: エラーログ出力
- 必須フィールド欠損: 警告ログ出力

## 7. ローカル実行時の動作

- `EXECUTION_MODE=local`の場合:
  - S3への保存をスキップ
  - `LOCAL_OUTPUT_DIR`にCSVファイルを保存
  - ディレクトリ構造はS3と同じ形式を維持

## 8. 決定事項

以下の点について決定しました：

1. **位置情報の形式**
   - イベントで渡される位置情報は緯度経度（lat, lon）
   - **複数地点を一度に処理する必要がある** - イベントで`locations`配列として指定可能

2. **タイムゾーン**
   - **前日の定義はローカルタイム（JST）基準**
   - 日付時刻フォーマットはISO形式でJST

3. **既存データの扱い**
   - **既に同じ月のデータが存在する場合、追記する**
   - **重複データのチェックを実施**（timestamp_utcとlat, lonの組み合わせで判定）

4. **エラー時の動作**
   - **エラー発生時の再実行は不要** - Lambdaの機能で行う

5. **CSVの詳細仕様**
   - **エンコーディング: Shift-JIS**
   - 区切り文字: カンマ
   - **日付時刻フォーマット: ISO形式（JST）**

6. **ネストされたオブジェクトの展開方法**
   - `weather`オブジェクトは`weather_code`、`weather_description`、`weather_icon`のように展開

## 9. 実装ファイル構成

```
weatherbit/
├── lambda_function.py      # Lambda関数本体
├── requirements.txt        # Python依存パッケージ
├── config.py              # 設定管理
├── weatherbit_client.py    # Weatherbit APIクライアント
├── csv_converter.py        # JSON→CSV変換
├── s3_handler.py           # S3操作
├── local_handler.py        # ローカルファイル操作
└── tests/                  # テストコード
    ├── test_lambda_function.py
    └── test_csv_converter.py
```

## 10. 依存パッケージ

- `boto3`: AWS SDK
- `requests`: HTTPリクエスト
- `pandas`: データ処理（オプション、CSV変換に使用する場合）

